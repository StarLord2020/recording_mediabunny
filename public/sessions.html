<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Mediabunny ‚Äî –°–µ—Å—Å–∏–∏</title>
  <script src="./mediabunny.umd.js"></script>
  <script src="./idb-recorder.js"></script>
  <style>
    body { font: 14px/1.4 system-ui, sans-serif; margin: 12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; margin: 8px 0; }
    .progress { position: relative; width: 520px; height: 10px; background: #eee; border-radius: 6px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.15); }
    .progress__bar { height:100%; width:0%; background: linear-gradient(90deg,#4caf50,#2e7d32); transition: width 0.1s ease; }
  </style>
</head>
<body>
  <h2>üìÅ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Å—Å–∏–π</h2>
  <div class="row">
    <select id="sessionSelect" style="min-width:420px;"></select>
    <button id="refreshBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button id="toFileBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª</button>
    <button id="toBlobBtn">‚¨á –°–∫–∞—á–∞—Ç—å –∫–∞–∫ —Ñ–∞–π–ª</button>
  </div>
  <fieldset style="margin:8px 0; padding:8px; border:1px solid #ddd; border-radius:6px;">
    <legend>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</legend>
    <div class="row">
      <label>Cache (MB): <input id="cacheMB" type="number" min="0" step="16" value="128" style="width:100px;"></label>
      <label>Prefetch: 
        <select id="prefetch">
          <option value="none">none</option>
          <option value="fileSystem" selected>fileSystem</option>
          <option value="network">network</option>
        </select>
      </label>
      <label><input id="forceAudio" type="checkbox"> Audio forceTranscode</label>
      <label><input id="forceVideo" type="checkbox"> Video forceTranscode</label>
      <label>Pad (MB): <input id="padMB" type="number" min="0" step="100" value="0" style="width:100px;"></label>
    </div>
    <div class="row">
      <div>
        <div class="progress" style="width:520px"><div class="progress__bar" id="progressIndexBar"></div></div>
        <div id="progressIndexText">–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è 0%</div>
      </div>
      <div>
        <div class="progress" style="width:520px"><div class="progress__bar" id="progressBar"></div></div>
        <div id="progressText">–ö–æ–Ω–≤–µ—Ä—Å–∏—è 0%</div>
      </div>
      <div>
        <div class="progress" style="width:520px"><div class="progress__bar" id="progressLibBar"></div></div>
        <div id="progressLibText">–ü—Ä–æ–≥—Ä–µ—Å—Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ 0%</div>
      </div>
      <div>
        <div class="progress" style="width:520px"><div class="progress__bar" id="progressFinalBar"></div></div>
        <div id="progressFinalText">–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è 0%</div>
      </div>
    </div>
    <div class="row">
      <div id="totalTimeText">–ò—Ç–æ–≥–æ: 0.0 —Å</div>
    </div>
  </fieldset>

  <script type="module">
    import { listSessionsSorted, remuxSessionToFile, remuxSessionToBlob } from './services/remuxService.js';

    const selectEl = document.getElementById('sessionSelect');
    const refreshBtn = document.getElementById('refreshBtn');
    const toFileBtn = document.getElementById('toFileBtn');
    const toBlobBtn = document.getElementById('toBlobBtn');
    const cacheMBEl = document.getElementById('cacheMB');
    const prefetchEl = document.getElementById('prefetch');
    const forceAudioEl = document.getElementById('forceAudio');
    const forceVideoEl = document.getElementById('forceVideo');
    const padMBEl = document.getElementById('padMB');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressLibBar = document.getElementById('progressLibBar');
    const progressLibText = document.getElementById('progressLibText');
    const progressFinalBar = document.getElementById('progressFinalBar');
    const progressFinalText = document.getElementById('progressFinalText');
    const totalTimeText = document.getElementById('totalTimeText');
    const progressIndexBar = document.getElementById('progressIndexBar');
    const progressIndexText = document.getElementById('progressIndexText');

    function setProgress(p) {
      const v = Math.max(0, Math.min(1, p||0));
      progressBar.style.width = `${(v*100).toFixed(1)}%`;
      progressText.textContent = `–ö–æ–Ω–≤–µ—Ä—Å–∏—è ${(v*100).toFixed(1)}%`;
    }
    function setIndexProgress(p) {
      const v = Math.max(0, Math.min(1, p||0));
      progressIndexBar.style.width = `${(v*100).toFixed(1)}%`;
      progressIndexText.textContent = `–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è ${(v*100).toFixed(1)}%`;
    }
    function setLibProgress(p) {
      const v = Math.max(0, Math.min(1, p||0));
      progressLibBar.style.width = `${(v*100).toFixed(1)}%`;
      progressLibText.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ${(v*100).toFixed(1)}%`;
    }
    let finalizeTimer = null;
    function startFinalize() {
      if (finalizeTimer) return;
      progressFinalBar.style.width = '5%';
      progressFinalText.textContent = '–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶';
      let w = 5;
      finalizeTimer = setInterval(() => {
        w += 3; if (w > 95) w = 10; // –∏–º–∏—Ç–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
        progressFinalBar.style.width = `${w}%`;
      }, 150);
    }
    function endFinalize() {
      if (finalizeTimer) { clearInterval(finalizeTimer); finalizeTimer = null; }
      progressFinalBar.style.width = '100%';
      progressFinalText.textContent = '–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è 100%';
      setTimeout(() => { progressFinalBar.style.width = '0%'; progressFinalText.textContent = '–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è 0%'; }, 800);
    }

    async function loadSessions() {
      selectEl.innerHTML = '';
      const sessions = await listSessionsSorted();
      for (const s of sessions) {
        const started = s.startedAt ? new Date(s.startedAt).toLocaleString() : '–±–µ–∑ –¥–∞—Ç—ã';
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${started} ‚Äî ${s.chunkCount||0} —á–∞–Ω–∫–æ–≤`;
        opt.dataset.mime = s.mimeType || 'video/webm';
        selectEl.appendChild(opt);
      }
    }

    refreshBtn.onclick = loadSessions;
    toFileBtn.onclick = async () => {
      try {
        const id = selectEl.value; if (!id) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é'); return; }
        if (!window.showSaveFilePicker) { alert('–ù—É–∂–µ–Ω File System Access API'); return; }
        const handle = await window.showSaveFilePicker({ suggestedName: `session-${new Date().toISOString().replace(/[:.]/g,'-')}.webm`, types: [{ description:'WebM', accept: {'video/webm':['.webm']}}] });
        setProgress(0); setLibProgress(0); setIndexProgress(0); endFinalize();
        const t0 = performance.now();
        await remuxSessionToFile(id, handle, {
          cacheMB: Number(cacheMBEl.value||0),
          prefetch: prefetchEl.value,
          forceAudio: !!forceAudioEl.checked,
          forceVideo: !!forceVideoEl.checked,
          padMB: Number(padMBEl.value||0),
          onIndexProgress: setIndexProgress,
          // –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º byte-based –ø—Ä–æ–≥—Ä–µ—Å—Å
          onByteProgress: setProgress,
          // –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Mediabunny
          onProgress: (p) => { setLibProgress(p); if (p >= 1) startFinalize(); }
        });
        setProgress(1);
        setTimeout(()=> setProgress(0), 800);
        setIndexProgress(0);
        endFinalize();
        const t1 = performance.now();
        totalTimeText.textContent = `–ò—Ç–æ–≥–æ: ${((t1 - t0)/1000).toFixed(1)} —Å`;
      } catch (e) {
        console.warn('toFile failed', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª');
      }
    };
    toBlobBtn.onclick = async () => {
      try {
        const id = selectEl.value; if (!id) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é'); return; }
        setProgress(0); setLibProgress(0); setIndexProgress(0); endFinalize();
        const t0 = performance.now();
        const blob = await remuxSessionToBlob(id, {
          cacheMB: Number(cacheMBEl.value||0),
          prefetch: prefetchEl.value,
          forceAudio: !!forceAudioEl.checked,
          forceVideo: !!forceVideoEl.checked,
          onIndexProgress: setIndexProgress,
          onByteProgress: setProgress,
          onProgress: (p) => { setLibProgress(p); if (p >= 1) startFinalize(); }
        });
        const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: `session-${new Date().toISOString().replace(/[:.]/g,'-')}.webm` });
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
        setProgress(1);
        setTimeout(()=> setProgress(0), 800);
        setIndexProgress(0);
        endFinalize();
        const t1 = performance.now();
        totalTimeText.textContent = `–ò—Ç–æ–≥–æ: ${((t1 - t0)/1000).toFixed(1)} —Å`;
      } catch (e) {
        console.warn('toBlob failed', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –≤ Blob');
      }
    };

    loadSessions();
  </script>
</body>
</html>
