<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Mediabunny ‚Äî –°–µ—Å—Å–∏–∏</title>
  <script src="./mediabunny.umd.js"></script>
  <script src="./idb-recorder.js"></script>
  <style>
    body { font: 14px/1.4 system-ui, sans-serif; margin: 12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; margin: 8px 0; }
    .progress { position: relative; width: 520px; height: 10px; background: #eee; border-radius: 6px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.15); }
    .progress__bar { height:100%; width:0%; background: linear-gradient(90deg,#4caf50,#2e7d32); transition: width 0.1s ease; }
  </style>
</head>
<body>
  <h2>üìÅ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Å—Å–∏–π</h2>
  <div class="row">
    <select id="sessionSelect" style="min-width:420px;"></select>
    <button id="refreshBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button id="toFileBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª</button>
    <button id="toBlobBtn">‚¨á –°–∫–∞—á–∞—Ç—å –∫–∞–∫ —Ñ–∞–π–ª</button>
    <label>–†–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏ (–ú–ë): <input id="partMB" type="number" min="256" step="256" value="1024" style="width:100px;"></label>
    <button id="toPartsBtn">üß© –°–∫–∞—á–∞—Ç—å –ø–æ —á–∞—Å—Ç—è–º</button>
  </div>
  <fieldset style="margin:8px 0; padding:8px; border:1px solid #ddd; border-radius:6px;">
    <legend>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</legend>
    <div class="row">
      <label>Cache (MB): <input id="cacheMB" type="number" min="0" step="16" value="128" style="width:100px;"></label>
      <label>Prefetch: 
        <select id="prefetch">
          <option value="none">none</option>
          <option value="fileSystem" selected>fileSystem</option>
          <option value="network">network</option>
        </select>
      </label>
      <label><input id="forceAudio" type="checkbox"> Audio forceTranscode</label>
      <label><input id="forceVideo" type="checkbox"> Video forceTranscode</label>
      <label>Pad (MB): <input id="padMB" type="number" min="0" step="100" value="0" style="width:100px;"></label>
    </div>
    <div class="row">
      <div>
        <div class="progress" style="width:520px"><div class="progress__bar" id="progressIndexBar"></div></div>
        <div id="progressIndexText">1) –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —á–∞–Ω–∫–æ–≤): 0%</div>
      </div>
      <div>
        <div class="progress" style="width:520px"><div class="progress__bar" id="progressBar"></div></div>
        <div id="progressText">2) –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–±–∞–π—Ç—ã): 0%</div>
      </div>
      <div>
        <div class="progress" style="width:520px"><div class="progress__bar" id="progressLibBar"></div></div>
        <div id="progressLibText">3) –û–±—Ä–∞–±–æ—Ç–∫–∞ (–ø—Ä–æ–≥—Ä–µ—Å—Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏): 0%</div>
      </div>
      <div>
        <div class="progress" style="width:520px"><div class="progress__bar" id="progressFinalBar"></div></div>
        <div id="progressFinalText">4) –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏: 0%</div>
      </div>
    </div>
    <div class="row">
      <div id="totalTimeText">–ò—Ç–æ–≥–æ: 0.0 —Å</div>
    </div>
  </fieldset>

  <script type="module">
    import { listSessionsSorted, remuxSessionToFile, remuxSessionToBlob, buildSessionIndex, groupChunksByTargetSize, remuxChunkRangeToBlob } from './services/remuxService.js';

    const selectEl = document.getElementById('sessionSelect');
    const refreshBtn = document.getElementById('refreshBtn');
    const toFileBtn = document.getElementById('toFileBtn');
    const toBlobBtn = document.getElementById('toBlobBtn');
    const toPartsBtn = document.getElementById('toPartsBtn');
    const partMBEl = document.getElementById('partMB');
    const cacheMBEl = document.getElementById('cacheMB');
    const prefetchEl = document.getElementById('prefetch');
    const forceAudioEl = document.getElementById('forceAudio');
    const forceVideoEl = document.getElementById('forceVideo');
    const padMBEl = document.getElementById('padMB');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressLibBar = document.getElementById('progressLibBar');
    const progressLibText = document.getElementById('progressLibText');
    const progressFinalBar = document.getElementById('progressFinalBar');
    const progressFinalText = document.getElementById('progressFinalText');
    const totalTimeText = document.getElementById('totalTimeText');
    const progressIndexBar = document.getElementById('progressIndexBar');
    const progressIndexText = document.getElementById('progressIndexText');

    function setProgress(p) {
      const v = Math.max(0, Math.min(1, p||0));
      progressBar.style.width = `${(v*100).toFixed(1)}%`;
      progressText.textContent = `2) –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–±–∞–π—Ç—ã): ${(v*100).toFixed(1)}%`;
    }
    function setIndexProgress(p) {
      const v = Math.max(0, Math.min(1, p||0));
      progressIndexBar.style.width = `${(v*100).toFixed(1)}%`;
      progressIndexText.textContent = `1) –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —á–∞–Ω–∫–æ–≤): ${(v*100).toFixed(1)}%`;
    }
    function setLibProgress(p) {
      const v = Math.max(0, Math.min(1, p||0));
      progressLibBar.style.width = `${(v*100).toFixed(1)}%`;
      progressLibText.textContent = `3) –û–±—Ä–∞–±–æ—Ç–∫–∞ (–ø—Ä–æ–≥—Ä–µ—Å—Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏): ${(v*100).toFixed(1)}%`;
    }
    let finalizeTimer = null; let finalizeStartTs = 0; let finalizeTotalMs = 1200;
    function startFinalize(totalMs = 1200) {
      resetFinalize();
      finalizeTotalMs = Math.max(200, totalMs|0);
      finalizeStartTs = performance.now();
      progressFinalBar.style.width = '0%';
      progressFinalText.textContent = '4) –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏: 0%';
      finalizeTimer = setInterval(() => {
        const elapsed = performance.now() - finalizeStartTs;
        const v = Math.max(0, Math.min(1, elapsed / finalizeTotalMs));
        progressFinalBar.style.width = `${(v*100).toFixed(1)}%`;
        progressFinalText.textContent = `4) –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏: ${(v*100).toFixed(1)}%`;
        if (v >= 0.98) { clearInterval(finalizeTimer); finalizeTimer = null; }
      }, 100);
    }
    function endFinalize() {
      if (finalizeTimer) { clearInterval(finalizeTimer); finalizeTimer = null; }
      progressFinalBar.style.width = '100%';
      progressFinalText.textContent = '4) –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏: 100%';
      setTimeout(() => { resetFinalize(); }, 800);
    }
    function resetFinalize() {
      if (finalizeTimer) { clearInterval(finalizeTimer); finalizeTimer = null; }
      progressFinalBar.style.width = '0%';
      progressFinalText.textContent = '4) –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏: 0%';
    }

    async function loadSessions() {
      selectEl.innerHTML = '';
      const sessions = await listSessionsSorted();
      for (const s of sessions) {
        const started = s.startedAt ? new Date(s.startedAt).toLocaleString() : '–±–µ–∑ –¥–∞—Ç—ã';
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${started} ‚Äî ${s.chunkCount||0} —á–∞–Ω–∫–æ–≤`;
        opt.dataset.mime = s.mimeType || 'video/webm';
        selectEl.appendChild(opt);
      }
    }

    refreshBtn.onclick = loadSessions;
    toFileBtn.onclick = async () => {
      try {
        const id = selectEl.value; if (!id) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é'); return; }
        if (!window.showSaveFilePicker) { alert('–ù—É–∂–µ–Ω File System Access API'); return; }
        const handle = await window.showSaveFilePicker({ suggestedName: `session-${new Date().toISOString().replace(/[:.]/g,'-')}.webm`, types: [{ description:'WebM', accept: {'video/webm':['.webm']}}] });
        setProgress(0); setLibProgress(0); setIndexProgress(0); resetFinalize();
        const t0 = performance.now();
        await remuxSessionToFile(id, handle, {
          cacheMB: Number(cacheMBEl.value||0),
          prefetch: prefetchEl.value,
          forceAudio: !!forceAudioEl.checked,
          forceVideo: !!forceVideoEl.checked,
          padMB: Number(padMBEl.value||0),
          onIndexProgress: setIndexProgress,
          // –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º byte-based –ø—Ä–æ–≥—Ä–µ—Å—Å
          onByteProgress: setProgress,
          // –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Mediabunny
          onProgress: (p) => { setLibProgress(p); if (p >= 1) startFinalize(); }
        });
        setProgress(1);
        setTimeout(()=> setProgress(0), 800);
        setIndexProgress(0);
        endFinalize();
        setTimeout(()=> setLibProgress(0), 800);
        const t1 = performance.now();
        totalTimeText.textContent = `–ò—Ç–æ–≥–æ: ${((t1 - t0)/1000).toFixed(1)} —Å`;
      } catch (e) {
        console.warn('toFile failed', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª');
      }
    };
    toBlobBtn.onclick = async () => {
      try {
        const id = selectEl.value; if (!id) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é'); return; }
        setProgress(0); setLibProgress(0); setIndexProgress(0); resetFinalize();
        const t0 = performance.now();
        const blob = await remuxSessionToBlob(id, {
          cacheMB: Number(cacheMBEl.value||0),
          prefetch: prefetchEl.value,
          forceAudio: !!forceAudioEl.checked,
          forceVideo: !!forceVideoEl.checked,
          onIndexProgress: setIndexProgress,
          onByteProgress: setProgress,
          onProgress: (p) => { setLibProgress(p); if (p >= 1) startFinalize(); }
        });
        const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: `session-${new Date().toISOString().replace(/[:.]/g,'-')}.webm` });
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
        setProgress(1);
        setTimeout(()=> setProgress(0), 800);
        setIndexProgress(0);
        endFinalize();
        setTimeout(()=> setLibProgress(0), 800);
        const t1 = performance.now();
        totalTimeText.textContent = `–ò—Ç–æ–≥–æ: ${((t1 - t0)/1000).toFixed(1)} —Å`;
      } catch (e) {
        console.warn('toBlob failed', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –≤ Blob');
      }
    };

    toPartsBtn.onclick = async () => {
      try {
        const id = selectEl.value; if (!id) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é'); return; }
        setProgress(0); setLibProgress(0); setIndexProgress(0); resetFinalize();
        const t0 = performance.now();
        // –°—Ç—Ä–æ–∏–º –∏–Ω–¥–µ–∫—Å –æ–¥–∏–Ω —Ä–∞–∑
        const index = await buildSessionIndex(id, 'video/webm', setIndexProgress);
        // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –≥—Ä—É–ø–ø—ã —á–∞–Ω–∫–æ–≤ –ø–æ ~—Ü–µ–ª–µ–≤–æ–º—É —Ä–∞–∑–º–µ—Ä—É
        const targetBytes = Math.max(256, Number(partMBEl.value||1024)) * 1024 * 1024;
        const groups = groupChunksByTargetSize(index, targetBytes);
        let partIndex = 1;
        for (const g of groups) {
          setProgress(0); setLibProgress(0); resetFinalize();
          const blob = await remuxChunkRangeToBlob(index, {
            startSeq: g.startSeq, endSeq: g.endSeq,
            cacheMB: Number(cacheMBEl.value||0), prefetch: prefetchEl.value,
            forceAudio: !!forceAudioEl.checked, forceVideo: !!forceVideoEl.checked,
            onProgress: setLibProgress,
            onByteProgress: setProgress
          });
          // –∫—Ä–∞—Ç–∫–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —á–∞—Å—Ç—è–º–∏
          startFinalize();
          // –°–∫–∞—á–∏–≤–∞–µ–º —á–∞—Å—Ç—å
          const a = Object.assign(document.createElement('a'), {
            href: URL.createObjectURL(blob),
            download: `session-${new Date().toISOString().replace(/[:.]/g,'-')}.part${String(partIndex).padStart(3,'0')}.webm`
          });
          document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
          endFinalize();
          setTimeout(()=> { setLibProgress(0); setProgress(0); }, 400);
          partIndex += 1;
        }
        const t1 = performance.now();
        totalTimeText.textContent = `–ò—Ç–æ–≥–æ: ${((t1 - t0)/1000).toFixed(1)} —Å`;
        setLibProgress(0); setProgress(0); setIndexProgress(0); resetFinalize();
      } catch (e) {
        console.warn('toParts failed', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –ø–æ —á–∞—Å—Ç—è–º');
      }
    };

    loadSessions();
  </script>
</body>
</html>
